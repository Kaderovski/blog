<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Freebsd Pci Disk Space - Kaderovski</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="When you create an OVH Public Cloud instance under Freebsd with a certain amount of disk space, let’s say 50G, you will find that it is not applied on your partition.
First let&rsquo;s look at what we have:
# gpart show => 40 10239920 da0 GPT (50G) [CORRUPT]  40 1024 1 freebsd-boot (512K)  1064 984 - free - (492K)  2048 10235904 2 freebsd-zfs (4.9G)  10237952 2008 - free - (1.">
<meta property="og:image" content>
<meta property="og:title" content="Freebsd Pci Disk Space">
<meta property="og:description" content="When you create an OVH Public Cloud instance under Freebsd with a certain amount of disk space, let’s say 50G, you will find that it is not applied on your partition.
First let&rsquo;s look at what we have:
# gpart show => 40 10239920 da0 GPT (50G) [CORRUPT]  40 1024 1 freebsd-boot (512K)  1064 984 - free - (492K)  2048 10235904 2 freebsd-zfs (4.9G)  10237952 2008 - free - (1.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kaderovski.com/posts/freebsd-pci-disk-space/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-03-04T14:56:33+00:00">
<meta property="article:modified_time" content="2018-03-04T14:56:33+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Freebsd Pci Disk Space">
<meta name=twitter:description content="When you create an OVH Public Cloud instance under Freebsd with a certain amount of disk space, let’s say 50G, you will find that it is not applied on your partition.
First let&rsquo;s look at what we have:
# gpart show => 40 10239920 da0 GPT (50G) [CORRUPT]  40 1024 1 freebsd-boot (512K)  1064 984 - free - (492K)  2048 10235904 2 freebsd-zfs (4.9G)  10237952 2008 - free - (1.">
<script src=https://kaderovski.com/js/feather.min.js></script>
<link href=https://kaderovski.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://kaderovski.com/css/main.012e5aa5cb264fd430bd3ad5b7db828508ccc0fc66b280031de12b7eec06ef85.css>
</head><body>
<div class=content><header>
<div class=main>
<a href=https://kaderovski.com>Kaderovski</a>
</div><nav>
<a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/about>About</a>
<a href=https://photos.kaderovski.com>Photos</a>
<a href=/cv>CV</a>
</nav></header><main>
<article>
<div class=title>
<h1 class=title>Freebsd Pci Disk Space</h1><div class=meta>Posted on Mar 4, 2018</div></div><section class=body>
<p>When you create an OVH Public Cloud instance under Freebsd with a certain amount of disk space, let’s say 50G, you will find that it is not applied on your partition.</p><p>First let&rsquo;s look at what we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart show
</span></span><span style=display:flex><span>=&gt;      40  10239920  da0  GPT  (50G) [CORRUPT]
</span></span><span style=display:flex><span>        40      1024    1  freebsd-boot  (512K)
</span></span><span style=display:flex><span>      1064       984       - free -  (492K)
</span></span><span style=display:flex><span>      2048  10235904    2  freebsd-zfs  (4.9G)
</span></span><span style=display:flex><span>  10237952      2008       - free -  (1.0M)
</span></span></code></pre></div><p>We note that our volume da0 is tagged as CORRUPT. Don&rsquo;t panic, everyone knows that the Freebsd handbook is great. I quote:</p><blockquote>
<p>If the disk was formatted with the GPT partitioning scheme, it may show as “corrupted” because the GPT backup partition table is no longer at the end of the drive. Fix the backup partition table with gpart:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart recover ada0
</span></span><span style=display:flex><span>ada0 recovered
</span></span></code></pre></div><p>Well, let&rsquo;s apply this to our server by replacing <code>ada0</code> by <code>da0</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart recover da0
</span></span><span style=display:flex><span>da0 recovered
</span></span></code></pre></div><p>Check :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart show
</span></span><span style=display:flex><span>=&gt;       40  104857520  da0  GPT  (50G)
</span></span><span style=display:flex><span>         40       1024    1  freebsd-boot  (512K)
</span></span><span style=display:flex><span>       1064        984       - free -  (492K)
</span></span><span style=display:flex><span>       2048   10235904    2  freebsd-zfs  (4.9G)
</span></span><span style=display:flex><span>   10237952   94619608       - free -  (45G)
</span></span></code></pre></div><p>Much better!
We see that our da0 &ldquo;disk&rdquo; has 50G. However if we look more closely at our system, we see that not all the space is present.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># df -h
</span></span><span style=display:flex><span>Filesystem            Size    Used   Avail Capacity  Mounted on
</span></span><span style=display:flex><span>zroot/ROOT/default    4.7G    493M    4.2G    10%    /
</span></span><span style=display:flex><span>devfs                 1.0K    1.0K      0B   100%    /dev
</span></span><span style=display:flex><span>zroot                 4.2G     96K    4.2G     0%    /zroot
</span></span></code></pre></div><p>Once again, don&rsquo;t panic. The handbook is our friend.</p><p>Let&rsquo;s apply the 45G free on our score :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart resize -i 2 -a 4k -s 50G da0
</span></span><span style=display:flex><span>da0p2 resized
</span></span></code></pre></div><p>Check :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># gpart show
</span></span><span style=display:flex><span>=&gt;       40  104857520  da0  GPT  (50G)
</span></span><span style=display:flex><span>         40       1024    1  freebsd-boot  (512K)
</span></span><span style=display:flex><span>       1064        984       - free -  (492K)
</span></span><span style=display:flex><span>       2048   94371840    2  freebsd-zfs  (45G)
</span></span><span style=display:flex><span>   94373888   10483672       - free -  (5.0G)
</span></span></code></pre></div><p>Well, we are moving forward, however, the space is not yet usable as the return from df :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># df -h
</span></span><span style=display:flex><span>Filesystem            Size    Used   Avail Capacity  Mounted on
</span></span><span style=display:flex><span>zroot/ROOT/default    4.7G    493M    4.2G    10%    /
</span></span><span style=display:flex><span>devfs                 1.0K    1.0K      0B   100%    /dev
</span></span><span style=display:flex><span>zroot                 4.2G     96K    4.2G     0%    /zroot
</span></span></code></pre></div><p>We must ask to our zpool to use this space.</p><p>Let’s first check our pool.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># zpool status
</span></span><span style=display:flex><span>  pool: zroot
</span></span><span style=display:flex><span> state: ONLINE
</span></span><span style=display:flex><span>  scan: none requested
</span></span><span style=display:flex><span>config:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	NAME        STATE     READ WRITE CKSUM
</span></span><span style=display:flex><span>	zroot       ONLINE       0     0     0
</span></span><span style=display:flex><span>	  da0p2     ONLINE       0     0     0
</span></span></code></pre></div><p>Ask it we want to autoexpand on zroot</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># zpool set autoexpand=on zroot
</span></span></code></pre></div><p>Apply it on da0p2 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># zpool online -e zroot /dev/da0p2
</span></span></code></pre></div><p>Last check :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># df -h
</span></span><span style=display:flex><span>Filesystem            Size    Used   Avail Capacity  Mounted on
</span></span><span style=display:flex><span>zroot/ROOT/default     44G    493M     43G     1%    /
</span></span><span style=display:flex><span>devfs                 1.0K    1.0K      0B   100%    /dev
</span></span><span style=display:flex><span>zroot                  43G     96K     43G     0%    /zroot
</span></span></code></pre></div><p>This is it !</p></section><div class=post-tags>
<nav class="nav tags">
<ul class=tags>
<li><a href=/tags/freebsd>freebsd</a></li><li><a href=/tags/ovh>ovh</a></li><li><a href=/tags/serveur>serveur</a></li><li><a href=/tags/publicloud>publicloud</a></li></ul></nav></div></article></main><footer>
<div style=display:flex><a class=soc href=https://github.com/kaderovski title=GitHub><i data-feather=github></i></a><a class=soc href=https://gitlab.com/kaderovski title=GitLab><i data-feather=gitlab></i></a></div><div class=footer-info>
2022 © Kaderovski
</div></footer><script>feather.replace()</script></div></body></html>