<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Setup Rancher cluster on OVH Public Cloud - Kaderovski</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The world of hosting is changing, and so is the world of application development. Today we are turning less and less to dedicated hosting for a single application, but more to build the infrastructure that will support it.
In this sense, we prefer to use an Iaas solution on dedicated &ldquo;bare metal&rdquo; for our application overlay than pure &ldquo;bare metal&rdquo; per service.
Application deployment missions pushed by developers must fit with the technology and logic of production."><meta property="og:image" content><meta property="og:title" content="Setup Rancher cluster on OVH Public Cloud"><meta property="og:description" content="The world of hosting is changing, and so is the world of application development. Today we are turning less and less to dedicated hosting for a single application, but more to build the infrastructure that will support it.
In this sense, we prefer to use an Iaas solution on dedicated &ldquo;bare metal&rdquo; for our application overlay than pure &ldquo;bare metal&rdquo; per service.
Application deployment missions pushed by developers must fit with the technology and logic of production."><meta property="og:type" content="article"><meta property="og:url" content="https://kaderovski.com/posts/cluster-rancher-public-cloud-ovh/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-08-04T19:04:11+00:00"><meta property="article:modified_time" content="2017-08-04T19:04:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup Rancher cluster on OVH Public Cloud"><meta name=twitter:description content="The world of hosting is changing, and so is the world of application development. Today we are turning less and less to dedicated hosting for a single application, but more to build the infrastructure that will support it.
In this sense, we prefer to use an Iaas solution on dedicated &ldquo;bare metal&rdquo; for our application overlay than pure &ldquo;bare metal&rdquo; per service.
Application deployment missions pushed by developers must fit with the technology and logic of production."><script src=https://kaderovski.com//js/feather.min.js></script>
<link href=https://kaderovski.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://kaderovski.com/css/main.012e5aa5cb264fd430bd3ad5b7db828508ccc0fc66b280031de12b7eec06ef85.css></head><body><div class=content><header><div class=main><a href=https://kaderovski.com/>Kaderovski</a></div><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/about>About</a>
<a href=https://photos.kaderovski.com>Photos</a>
<a href=/cv>CV</a></nav></header><main><article><div class=title><h1 class=title>Setup Rancher cluster on OVH Public Cloud</h1><div class=meta>Posted on Aug 4, 2017</div></div><section class=body><p><img src=/Images/rancher_logo.jpeg alt="Rancher logo"></p><p>The world of hosting is changing, and so is the world of application development. Today we are turning less and less to dedicated hosting for a single application, but more to build the infrastructure that will support it.</p><p>In this sense, we prefer to use an Iaas solution on dedicated &ldquo;bare metal&rdquo; for our application overlay than pure &ldquo;bare metal&rdquo; per service.</p><p>Application deployment missions pushed by developers must fit with the technology and logic of production. Which <code>pipelines</code> should we use for our <code>CI</code>, <code>CD</code> ?</p><p>This post will not aim at answering the question of the pipelines to be implemented, it will be a question of <code>Ranching</code>, coupled with its <code>Cattle</code> orchestrator, on Public Cloud OVH <code>Openstack</code>.</p><h3 id=installation->Installation :</h3><p>The installation of <code>PCI</code> (Public Cloud) instances is the fastest step. We need to start with 5 instances:</p><ul><li>1 LoadBalancer/ReverseProxy (<code>HA-Proxy</code> or <code>Nginx</code>) for €299</li><li>3 RancherServer in Cluster under <code>Galera</code> at 5€99</li><li>1 Node Worker (for our applications) at the price you want to put for your performance</li></ul><br>#### LoadBalancer Nginx :<p>For Nginx installation, nothing very complex, a €2.99 instance will be more than enough since the only job of the server will be to forward the request to our rancher cluster.</p><p>The conf file will be :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>upstream rancher {
</span></span><span style=display:flex><span>    server rancher-server1:8080;
</span></span><span style=display:flex><span>    server rancher-server2:8080;
</span></span><span style=display:flex><span>    server rancher-server3:8080;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>map $http_upgrade $connection_upgrade {
</span></span><span style=display:flex><span>    default Upgrade;
</span></span><span style=display:flex><span>    &#39;&#39;      close;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server {
</span></span><span style=display:flex><span>    listen 443 ssl spdy;
</span></span><span style=display:flex><span>    server_name &lt;server&gt;;
</span></span><span style=display:flex><span>    ssl_certificate &lt;cert_file&gt;;
</span></span><span style=display:flex><span>    ssl_certificate_key &lt;key_file&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location / {
</span></span><span style=display:flex><span>        proxy_set_header Host $host;
</span></span><span style=display:flex><span>        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span style=display:flex><span>        proxy_set_header X-Forwarded-Port $server_port;
</span></span><span style=display:flex><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        proxy_pass http://rancher;
</span></span><span style=display:flex><span>        proxy_http_version 1.1;
</span></span><span style=display:flex><span>        proxy_set_header Upgrade $http_upgrade;
</span></span><span style=display:flex><span>        proxy_set_header Connection $connection_upgrade;
</span></span><span style=display:flex><span>        proxy_read_timeout 900s;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server {
</span></span><span style=display:flex><span>    listen 80;
</span></span><span style=display:flex><span>    server_name &lt;server&gt;;
</span></span><span style=display:flex><span>    return 301 https://$server_name$request_uri;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Replace the <code>upstream</code> by the ips of your servers.</p><p>Note that it is also possible to dockerize this service. This way, the day you put a second LB on the front end, there will only be one container to place on your instance.</p><h4 id=rancher-installation->Rancher installation :</h4><p>For Rancher part, there are no great difficulties either. 5€99 instances will be more than enough for the needs.</p><p>I recommend the <a href=http://rancher.com/docs/rancher/v1.0/en/installing-rancher/installing-server/multi-nodes/>official Rancher documentation</a> on this subject.</p><p>We will start by deploying on each Rancher server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo docker run -d --restart=unless-stopped -p 8080:8080 rancher/server
</span></span></code></pre></div><p>Then we will add the servers to each other via the UI. (Infrastructure > Hosts > Add Host)</p><p>You should get the following code to run on each node :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo docker run -e CATTLE_AGENT_IP=&#34;1.2.3.4&#34;  -e CATTLE_HOST_LABELS=&#39;galera=true&#39;  --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/rancher:/var/lib/rancher rancher/agent:v1.2.5 http://1.2.3.4:8080/v1/scripts/4956918455D4D9BE3AF1:1483142400000:Fscj9CvRSrx0mS05E4kdWDkb0E
</span></span></code></pre></div><p>Once this step is done, it will then be possible to use the <code>Galera</code> image proposed by Rancher (in the catalog) on our 3 servers.
A node will then be present on each server.</p><p>We will be able to initialize the cluster on a Galera node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&gt; CREATE DATABASE IF NOT EXISTS cattle COLLATE = &#39;utf8_general_ci&#39; CHARACTER SET = &#39;utf8&#39;;
</span></span><span style=display:flex><span>&gt; GRANT ALL ON cattle.* TO &#39;cattle&#39;@&#39;%&#39; IDENTIFIED BY &#39;cattle&#39;;
</span></span><span style=display:flex><span>&gt; GRANT ALL ON cattle.* TO &#39;cattle&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;cattle&#39;;
</span></span></code></pre></div><p>Then check on the other two servers that the basic entries are also present.</p><p>Then let&rsquo;s stop one Rancher server and start it using Galera for persistence of its data :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo docker run -d --restart=unless-stopped -p 8080:8080 rancher/server \
</span></span><span style=display:flex><span>    --db-host myhost.example.com --db-port 3306 --db-user username --db-pass password --db-name cattle
</span></span></code></pre></div><p>Where :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>--db-host               IP du serveur MySQL
</span></span><span style=display:flex><span>--db-port               port du serveur MySQL (default: 3306)
</span></span><span style=display:flex><span>--db-user               username MySQL login (default: cattle)
</span></span><span style=display:flex><span>--db-pass               password MySQL login (default: cattle)
</span></span><span style=display:flex><span>--db-name               nom de la base MySQL (default: cattle)
</span></span></code></pre></div><p>Do the same for the other two servers so each Rancher launches using the Galera database.</p><p>Expected result:
<img src=/Images/RancherGalera.png alt="Galera Rancher"></p><p>It is possible to check if Rancher is <code>clustered</code> via the UI in: Admin > High Availability.</p><h4 id=addition-of-worker-nodes>Addition of Worker Nodes.</h4><p>You now have your <code>Rancher</code> cluster with a front-end LB, it is now possible to add <code>Worker</code> nodes to your cluster.
It&rsquo;s very easy to add them directly with the Rancher utility. Now it&rsquo;s up to you to see which type of instance best suits your resource needs.</p><p>Rancher&rsquo;s default environment uses the <code>Cattle' orchestrator, so once your Workers nodes are configured, you can deploy your </code>Docker&rsquo; containers directly from your cluster.</p><h3 id=conclusion>Conclusion</h3><p>The installation of a Rancher environment is fast, the Public Cloud OVH allows to quickly deploy the necessary instances of Rancher.
The ease of use offered by the Rancher/Cattle duo allows an efficient and fluid commissioning.</p><p>We will see in a next article how to set up an HA environment with <code>Kubernetes</code>, still under the OVH PCI and using the environment template proposed by Rancher.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/rancher>rancher</a></li><li><a href=/tags/cattle>cattle</a></li><li><a href=/tags/ovh>ovh</a></li><li><a href=/tags/pci>pci</a></li><li><a href=/tags/linux>linux</a></li><li><a href=/tags/docker>docker</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/kaderovski title=GitHub><i data-feather=github></i></a><a class=soc href=https://gitlab.com/kaderovski title=GitLab><i data-feather=gitlab></i></a></div><div class=footer-info>2022 © Kaderovski</div></footer><script>feather.replace()</script></div></body></html>